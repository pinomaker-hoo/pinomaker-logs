# 2023.05.11(목) Error Logs

## 목차

1. 같은 데이터에 동시 접근

<br />
<br />

### 1. 같은 데이터에 동시 접근

<br />

```
일반적으로 게임이 종료되면 경험치 혹은 게임 머니와 같은 보상을 얻게 되는 데 이 또한 서버에서 관리를 해주는 데이터 중 하나이다.

회사에서 개발한 게임에서 게임 머니와 경험치를 변경하는 API가 Response는 200임에도 변경이 되지 않는 문제가 발견 되었다.
```

<br />

회사에서 개발한 OX Quiz 게임의 데이터가 일정하지 않다는 이야기를 들었고, 이는 디버깅 결과 변경 API 호출 후 응답은 성공이지만 실제로 데이터 베이스 내의 데이터가 변경되지 않는 문제가 있었다.

서버 로그 상에서도 문제가 없었으며, 단순하게 데이터베이스의 값이 변경되지 않는 문제였는 데, 오히려 이는 심각한 문제라고 판단이 되었다. 실제로 개발을 할 때는 학교에 있을 때와 달리 Logging 및 모니터링에 있어서 많은 신경을 쓰는 데 거기에 걸리지 않은 것이지 않은가 더욱 문제는 API를 내가 호출 했을 경우에는 큰 문제가 있지 않지만 게임 내에서 호출할 경우 문제가 있었다.

<br />
(2) 해결 방법

<br />

이에 나는 문제에 대한 가설을 세웠다. API들이 별도로는 잘 작동 하는 데, 왜 게임에서만 문제가 있는 가? 이에 대해 User Table의 같은 유저의 데이터를 수정하는 데 게임 쪽에서 비동기로 3번을 요청하는 점을 생각하여 DB Lock에 대한 문제라고 생각이 되었다. 원래는 동시에 요청이 들어올 수 있는 것을 고려하여 수정되고 있는 데이터를 편집을 하지 못 하게 설정을 해야하는 데 이 부분이 미흡되었다고 판단 되어 서버 쪽에서는 트랜잭션 설정을 하였다.

다만 게임 쪽에서는 성능 문제로, 업데이트를 한 후에 Refetch를 한 것이 아닌 업데이트 될 값을 임의로 더해서 출력을 하고 있었는 데, 이는 1일 보상 제한으로 실제로 추가가 되지 않을 수도 있는 상황을 고려하지 않았기에, 게임에서도 업데이트 쿼리 후 데이터를 Refetch를 하였고, 혹시나 더 모를 상황에 대비하여 3개의 API를 동기로 호출을 하여 문제를 해결하였다.

API를 별도로 호출을 하였을 때는 문제가 없이 잘 변경되는 것을 확인하였다.

<br />
<br />

(3) 느낀 점

흔히들 하는 말이 대용량 트래픽에 대한 경험을 해야한다라는 말이 인터넷에서 많이 돌아다닌다. 이에 대해서는 당연히 동의하지만 신입 사원 혹은 주니어가 경험을 하기에는 너무 어려운 문제라고 생각하여 너무 동떨어진 현실이라고 생각했다. 하지만 대용량 트래픽과 유사한 동시성 문제를 직접 경험하고 나니 좀 더 데이터 베이스의 설정 문제에 대한 깊은 이해가 필요하다고 생각이 되었기에 ORM과 기본 제공 기능에 의존하지 말고 좀 더 학습을 해야겠다고 생각했다.
